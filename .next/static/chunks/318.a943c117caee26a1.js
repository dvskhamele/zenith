"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[318],{6634:function(e,o,r){r.d(o,{O:function(){return a}});let a=(0,r(8439).eI)("https://qfpvsyhtijwxkmyrqswa.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0")},6318:function(e,o,r){r.r(o),r.d(o,{facebookService:function(){return c},getFacebookPages:function(){return l},getFacebookProfile:function(){return i},getFacebookToken:function(){return n},publishToFacebook:function(){return g},testFacebookConnection:function(){return d}});var a=r(6634),t=r(6434).Buffer;class s{async getAccessToken(e){try{if(console.log("=== GET ACCESS TOKEN START ==="),e){console.log("Using override token, length:",e.length);let o=await this.validateToken(e);if(o.valid)return console.log("Override token validated successfully"),e;throw console.log("Override token is invalid:",o.error),Error("Invalid override token: ".concat(o.error))}{let e=localStorage.getItem("facebook_access_token");if(e){console.log("Token found in localStorage, length:",e.length);let o=await this.validateToken(e);if(o.valid)return console.log("Token validated successfully"),o.permissions&&console.log("Token permissions:",o.permissions),e;console.log("Stored token is invalid, removing it:",o.error),localStorage.removeItem("facebook_access_token")}}let{data:{session:o},error:r}=await a.O.auth.getSession();if(r&&console.error("Session error:",r),o){console.log("Supabase session found");let e=o.provider_token;if(e){console.log("Token found in Supabase session, length:",e.length);let o=await this.validateToken(e);if(o.valid)return console.log("Session token validated successfully"),e;console.log("Session token is invalid:",o.error)}}else console.log("No active Supabase session");{let e=localStorage.getItem("facebook_access_token");if(e)return console.log("Emergency fallback: Token found in localStorage, length:",e.length),e}return console.log("No Facebook access token found anywhere"),null}catch(e){console.error("Error getting Facebook access token:",e);try{{let e=localStorage.getItem("facebook_access_token");if(e)return console.log("Absolute emergency fallback: Token found in localStorage, length:",e.length),e}}catch(e){console.error("Absolute fallback failed:",e)}return null}}async validateToken(e){try{let r=await fetch("".concat(this.baseUrl,"/me?access_token=").concat(e,"&fields=id,name,email"));if(!r.ok){var o;let e=await r.json();return{valid:!1,error:(null===(o=e.error)||void 0===o?void 0:o.message)||"Token invalid"}}try{console.log("Token validation passed, skipping detailed permission check for now")}catch(e){console.log("Could not check token permissions:",e)}return{valid:!0}}catch(e){return console.error("Error validating Facebook token:",e),{valid:!1,error:e.message||"Token validation failed"}}}async getPages(){try{var e,o;console.log("=== GET PAGES METHOD START ===");let r=null;try{r=await this.getAccessToken(),console.log("Token from getAccessToken():",r?"Found":"Not found")}catch(e){console.log("Session token retrieval failed:",e.message)}if(!r){console.log("Trying direct localStorage access...");{let e=localStorage.getItem("facebook_access_token");e&&(r=e,console.log("Token found directly in localStorage"))}}if(!r)throw Error("No Facebook access token available from session or localStorage");console.log("Using token for pages request");let a=await this.validateToken(r);if(console.log("Token validity check:",a),!a.valid)throw Error("Facebook access token is invalid or expired: ".concat(a.error));if(a.permissions){let e=["pages_show_list","pages_read_engagement","pages_manage_posts"].filter(e=>!a.permissions.includes(e));e.length>0?console.log("Warning: Token missing required permissions:",e):console.log("Token has all required permissions")}try{let o=await fetch("".concat(this.baseUrl,"/me?access_token=").concat(r,"&fields=id,name,email")),a=await o.json();if(!o.ok)throw console.error("User profile API error:",a),Error((null===(e=a.error)||void 0===e?void 0:e.message)||"Failed to fetch user profile");console.log("User profile retrieved:",a.name)}catch(e){console.error("Error fetching user profile:",e)}console.log("Fetching Facebook pages with token...");let t=await fetch("".concat(this.baseUrl,"/me/accounts?access_token=").concat(r,"&fields=name,id,category,picture,fan_count")),s=await t.json();if(console.log("Pages API response:",s),!t.ok)throw console.error("Facebook pages API error:",s),Error((null===(o=s.error)||void 0===o?void 0:o.message)||"Failed to fetch Facebook pages");if(s&&s.data&&Array.isArray(s.data))return console.log("Pages retrieved successfully:",s.data.length),0===s.data.length&&(console.log("Warning: No pages found. This might be due to:"),console.log("1. User has no Facebook pages"),console.log("2. Token lacks pages_show_list permission"),console.log("3. User account is not a business account with page access")),s.data;return console.log("Unexpected response format:",s),[]}catch(e){throw console.error("Error fetching Facebook pages:",e),e}}async getProfile(){try{let o=await this.getAccessToken();if(!o)throw Error("No Facebook access token available");let r=await fetch("".concat(this.baseUrl,"/me?access_token=").concat(o,"&fields=id,name,email,picture")),a=await r.json();if(!r.ok){var e;throw Error((null===(e=a.error)||void 0===e?void 0:e.message)||"Failed to fetch Facebook profile")}return a}catch(e){throw console.error("Error fetching Facebook profile:",e),e}}async uploadImage(e){let o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r=arguments.length>2?arguments[2]:void 0,a=arguments.length>3?arguments[3]:void 0;try{let c=await this.getAccessToken(a);if(!c)throw Error("No Facebook access token available. Please reconnect your Facebook account.");let n=c,l="".concat(this.baseUrl,"/me/photos");if(r){console.log("Fetching page access token for page ID:",r);let e=await fetch("".concat(this.baseUrl,"/").concat(r,"?fields=access_token&access_token=").concat(c)),o=await e.json();if(!e.ok){var s;console.error("Error fetching page access token:",o);let e=(null===(s=o.error)||void 0===s?void 0:s.message)||"Failed to get page access token";throw Error("Failed to get page access token: ".concat(e))}n=o.access_token,l="".concat(this.baseUrl,"/").concat(r,"/photos"),console.log("Using page access token for image upload")}else console.log("Using user access token for image upload to personal feed");let i=t.from(e,"base64"),g=new FormData;g.append("source",new Blob([i],{type:"image/png"})),o&&g.append("caption",o),g.append("access_token",n),console.log("Uploading image to Facebook:",{url:l,hasCaption:!!o});let d=await fetch(l,{method:"POST",body:g}),k=await d.json();if(!d.ok){let e="Failed to upload image to Facebook";throw k&&k.error&&(e=k.error.message||k.error.type||e,console.error("Facebook API error details:",{type:k.error.type,code:k.error.code,fbtrace_id:k.error.fbtrace_id,message:k.error.message})),Error("Facebook API error: ".concat(e))}return console.log("Image uploaded to Facebook successfully:",k),{success:!0,data:k,facebook_post_id:k.post_id}}catch(e){if(console.error("Error uploading image to Facebook:",e),e instanceof Error)throw Error("Image upload failed: ".concat(e.message));throw Error("Image upload failed: Unknown error occurred")}}async publishPost(e,o,r){try{let t=await this.getAccessToken(r);if(!t)throw Error("No Facebook access token available. Please reconnect your Facebook account.");let s=await this.validateToken(t);if(!s.valid)throw Error("Facebook access token is invalid: ".concat(s.error||"Unknown error",". Please reconnect your Facebook account."));let c=t,n="".concat(this.baseUrl,"/me/feed");if(o){console.log("Fetching page access token for page ID:",o);let e=await fetch("".concat(this.baseUrl,"/").concat(o,"?fields=access_token&access_token=").concat(t)),r=await e.json();if(!e.ok){var a;console.error("Error fetching page access token:",r);let e=(null===(a=r.error)||void 0===a?void 0:a.message)||"Failed to get page access token";throw Error("Failed to get page access token: ".concat(e))}c=r.access_token,n="".concat(this.baseUrl,"/").concat(o,"/feed"),console.log("Using page access token for publishing")}else console.log("Using user access token for publishing to personal feed");let l={message:e,access_token:c};console.log("Publishing to Facebook:",{url:n,hasMessage:!!l.message});let i=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)}),g=await i.json();if(!i.ok){let e="Failed to publish to Facebook";throw g&&g.error&&(e=g.error.message||g.error.type||e,console.error("Facebook API error details:",{type:g.error.type,code:g.error.code,fbtrace_id:g.error.fbtrace_id,message:g.error.message})),Error("Facebook API error: ".concat(e))}return console.log("Post published to Facebook successfully:",g),{success:!0,data:g,facebook_post_id:g.id}}catch(e){if(console.error("Error publishing to Facebook:",e),e instanceof Error)throw Error("Publish failed: ".concat(e.message));throw Error("Publish failed: Unknown error occurred")}}async testConnection(){try{let e=await this.getAccessToken();if(!e)return{connected:!1};let o=await this.validateToken(e);if(!o.valid)return{connected:!1};let r=await this.getProfile(),a=await this.getPages();return{connected:!0,user:r,pages:a,tokenInfo:o}}catch(e){return console.error("Error testing Facebook connection:",e),{connected:!1}}}constructor(){this.baseUrl="https://graph.facebook.com/v19.0"}}let c=new s,n=()=>c.getAccessToken(),l=()=>c.getPages(),i=()=>c.getProfile(),g=(e,o)=>c.publishPost(e,o),d=()=>c.testConnection()}}]);