"use strict";exports.id=3589,exports.ids=[3589],exports.modules={49303:(e,o,r)=>{e.exports=r(30517)},7030:(e,o,r)=>{r.d(o,{O:()=>s});let s=(0,r(69498).eI)("https://qfpvsyhtijwxkmyrqswa.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0")},56773:(e,o,r)=>{r.d(o,{KD:()=>t});var s=r(7030);class a{async getAccessToken(e){try{if(console.log("=== GET ACCESS TOKEN START ==="),e){console.log("Using override token, length:",e.length);let o=await this.validateToken(e);if(o.valid)return console.log("Override token validated successfully"),e;throw console.log("Override token is invalid:",o.error),Error(`Invalid override token: ${o.error}`)}let{data:{session:o},error:r}=await s.O.auth.getSession();if(r&&console.error("Session error:",r),o){console.log("Supabase session found");let e=o.provider_token;if(e){console.log("Token found in Supabase session, length:",e.length);let o=await this.validateToken(e);if(o.valid)return console.log("Session token validated successfully"),e;console.log("Session token is invalid:",o.error)}}else console.log("No active Supabase session");return console.log("No Facebook access token found anywhere"),null}catch(e){return console.error("Error getting Facebook access token:",e),null}}async validateToken(e){try{let o=await fetch(`${this.baseUrl}/me?access_token=${e}&fields=id,name,email`);if(!o.ok){let e=await o.json();return{valid:!1,error:e.error?.message||"Token invalid"}}try{console.log("Token validation passed, skipping detailed permission check for now")}catch(e){console.log("Could not check token permissions:",e)}return{valid:!0}}catch(e){return console.error("Error validating Facebook token:",e),{valid:!1,error:e.message||"Token validation failed"}}}async getPages(){try{console.log("=== GET PAGES METHOD START ===");let e=null;try{e=await this.getAccessToken(),console.log("Token from getAccessToken():",e?"Found":"Not found")}catch(e){console.log("Session token retrieval failed:",e.message)}if(e||console.log("Trying direct localStorage access..."),!e)throw Error("No Facebook access token available from session or localStorage");console.log("Using token for pages request");let o=await this.validateToken(e);if(console.log("Token validity check:",o),!o.valid)throw Error(`Facebook access token is invalid or expired: ${o.error}`);if(o.permissions){let e=["pages_show_list","pages_read_engagement","pages_manage_posts"].filter(e=>!o.permissions.includes(e));e.length>0?console.log("Warning: Token missing required permissions:",e):console.log("Token has all required permissions")}try{let o=await fetch(`${this.baseUrl}/me?access_token=${e}&fields=id,name,email`),r=await o.json();if(!o.ok)throw console.error("User profile API error:",r),Error(r.error?.message||"Failed to fetch user profile");console.log("User profile retrieved:",r.name)}catch(e){console.error("Error fetching user profile:",e)}console.log("Fetching Facebook pages with token...");let r=await fetch(`${this.baseUrl}/me/accounts?access_token=${e}&fields=name,id,category,picture,fan_count`),s=await r.json();if(console.log("Pages API response:",s),!r.ok)throw console.error("Facebook pages API error:",s),Error(s.error?.message||"Failed to fetch Facebook pages");if(s&&s.data&&Array.isArray(s.data))return console.log("Pages retrieved successfully:",s.data.length),0===s.data.length&&(console.log("Warning: No pages found. This might be due to:"),console.log("1. User has no Facebook pages"),console.log("2. Token lacks pages_show_list permission"),console.log("3. User account is not a business account with page access")),s.data;return console.log("Unexpected response format:",s),[]}catch(e){throw console.error("Error fetching Facebook pages:",e),e}}async getProfile(){try{let e=await this.getAccessToken();if(!e)throw Error("No Facebook access token available");let o=await fetch(`${this.baseUrl}/me?access_token=${e}&fields=id,name,email,picture`),r=await o.json();if(!o.ok)throw Error(r.error?.message||"Failed to fetch Facebook profile");return r}catch(e){throw console.error("Error fetching Facebook profile:",e),e}}async uploadImage(e,o="",r,s){try{let a=await this.getAccessToken(s);if(!a)throw Error("No Facebook access token available. Please reconnect your Facebook account.");let t=a,c=`${this.baseUrl}/me/photos`;if(r){console.log("Fetching page access token for page ID:",r);let e=await fetch(`${this.baseUrl}/${r}?fields=access_token&access_token=${a}`),o=await e.json();if(!e.ok){console.error("Error fetching page access token:",o);let e=o.error?.message||"Failed to get page access token";throw Error(`Failed to get page access token: ${e}`)}t=o.access_token,c=`${this.baseUrl}/${r}/photos`,console.log("Using page access token for image upload")}else console.log("Using user access token for image upload to personal feed");let n=Buffer.from(e,"base64"),i=new FormData;i.append("source",new Blob([n],{type:"image/png"})),o&&i.append("caption",o),i.append("access_token",t),console.log("Uploading image to Facebook:",{url:c,hasCaption:!!o});let l=await fetch(c,{method:"POST",body:i}),g=await l.json();if(!l.ok){let e="Failed to upload image to Facebook";throw g&&g.error&&(e=g.error.message||g.error.type||e,console.error("Facebook API error details:",{type:g.error.type,code:g.error.code,fbtrace_id:g.error.fbtrace_id,message:g.error.message})),Error(`Facebook API error: ${e}`)}return console.log("Image uploaded to Facebook successfully:",g),{success:!0,data:g,facebook_post_id:g.post_id}}catch(e){if(console.error("Error uploading image to Facebook:",e),e instanceof Error)throw Error(`Image upload failed: ${e.message}`);throw Error("Image upload failed: Unknown error occurred")}}async publishPost(e,o,r){try{let s=await this.getAccessToken(r);if(!s)throw Error("No Facebook access token available. Please reconnect your Facebook account.");let a=await this.validateToken(s);if(!a.valid)throw Error(`Facebook access token is invalid: ${a.error||"Unknown error"}. Please reconnect your Facebook account.`);let t=s,c=`${this.baseUrl}/me/feed`;if(o){console.log("Fetching page access token for page ID:",o);let e=await fetch(`${this.baseUrl}/${o}?fields=access_token&access_token=${s}`),r=await e.json();if(!e.ok){console.error("Error fetching page access token:",r);let e=r.error?.message||"Failed to get page access token";throw Error(`Failed to get page access token: ${e}`)}t=r.access_token,c=`${this.baseUrl}/${o}/feed`,console.log("Using page access token for publishing")}else console.log("Using user access token for publishing to personal feed");let n={message:e,access_token:t};console.log("Publishing to Facebook:",{url:c,hasMessage:!!n.message});let i=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),l=await i.json();if(!i.ok){let e="Failed to publish to Facebook";throw l&&l.error&&(e=l.error.message||l.error.type||e,console.error("Facebook API error details:",{type:l.error.type,code:l.error.code,fbtrace_id:l.error.fbtrace_id,message:l.error.message})),Error(`Facebook API error: ${e}`)}return console.log("Post published to Facebook successfully:",l),{success:!0,data:l,facebook_post_id:l.id}}catch(e){if(console.error("Error publishing to Facebook:",e),e instanceof Error)throw Error(`Publish failed: ${e.message}`);throw Error("Publish failed: Unknown error occurred")}}async testConnection(){try{let e=await this.getAccessToken();if(!e)return{connected:!1};let o=await this.validateToken(e);if(!o.valid)return{connected:!1};let r=await this.getProfile(),s=await this.getPages();return{connected:!0,user:r,pages:s,tokenInfo:o}}catch(e){return console.error("Error testing Facebook connection:",e),{connected:!1}}}constructor(){this.baseUrl="https://graph.facebook.com/v19.0"}}let t=new a}};